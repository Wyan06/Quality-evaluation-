<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ä¸´æ²‚å¸‚å…¬ç«‹åŒ»é™¢åŒ»ç–—æœåŠ¡è´¨é‡è¯„ä»·è®¡ç®—å™¨ï¼ˆå¢å¼ºç‰ˆï¼‰</title>

    <!-- å¼•å…¥ Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- å¼•å…¥ xlsx.full.min.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- å¼•å…¥ jsPDF å’Œ autotable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.20/jspdf.plugin.autotable.min.js"></script>
    <!-- å¼•å…¥ LZString å‹ç¼©åº“ï¼ˆç”¨äºURLä¼ è¾“å¤§æ•°æ®ï¼‰ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>

    <style>
        body { 
            font-family: 'Microsoft YaHei', sans-serif; 
            margin: 20px; 
            background: #f4f6f9; 
            color: #333;
        }
        h1 { 
            color: #1a5fb4; 
            text-align: center; 
            margin-bottom: 10px;
        }
        .subtitle {
            text-align: center;
            color: #666;
            font-size: 1.1em;
            margin-top: 5px;
        }
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            background: white; 
            padding: 20px; 
            border-radius: 10px; 
            box-shadow: 0 0 10px rgba(0,0,0,0.1); 
        }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin: 20px 0; 
            font-size: 0.9em;
        }
        th, td { 
            border: 1px solid #ccc; 
            padding: 8px; 
            text-align: center; 
        }
        th { 
            background-color: #e6f0ff; 
            color: #1a5fb4;
        }
        input, select { 
            width: 90%; 
            text-align: center; 
            padding: 5px; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
        }
        button { 
            padding: 10px 15px; 
            background: #1a5fb4; 
            color: white; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            margin: 5px; 
            font-size: 0.95em;
        }
        button:hover { background: #0d47a1; }
        button.success { background: #28a745; }
        button.export { background: #fd7e14; }
        button.share { background: #6f42c1; }
        .chart-container { height: 500px; margin: 30px 0; }
        .instructions { 
            background: #fff3cd; 
            padding: 15px; 
            border: 1px solid #ffeaa7; 
            border-radius: 5px; 
            font-size: 0.9em; 
            margin: 20px 0;
        }
        .upload-area {
            border: 3px dashed #1a5fb4;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            background: #e6f0ff;
            margin: 20px 0;
        }
        .loading {
            display: none;
            text-align: center;
            color: #1a5fb4;
            font-weight: bold;
            margin: 15px 0;
        }
        footer {
            text-align: center;
            margin-top: 40px;
            color: #888;
            font-size: 0.9em;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ¥ ä¸´æ²‚å¸‚å…¬ç«‹åŒ»é™¢åŒ»ç–—æœåŠ¡è´¨é‡è¯„ä»·è®¡ç®—å™¨ï¼ˆå¢å¼ºç‰ˆï¼‰</h1>
    <p class="subtitle">æ”¯æŒ14é¡¹æ ¸å¿ƒæŒ‡æ ‡ | TOPSIS+ç†µæƒæ³• | diâº/diâ»/Ciå®Œæ•´è¾“å‡º | Excelä¸Šä¼ +PDFå¯¼å‡º</p>

    <div class="instructions">
        <strong>ğŸ“Œ ä½¿ç”¨è¯´æ˜ï¼š</strong>
        <ol>
            <li><strong>æ‰‹åŠ¨å¡«å†™</strong>ï¼šç›´æ¥åœ¨è¡¨æ ¼ä¸­ä¿®æ”¹åŒ»é™¢å’ŒæŒ‡æ ‡å€¼</li>
            <li><strong>Excelä¸Šä¼ </strong>ï¼šç‚¹å‡»ã€é€‰æ‹©æ–‡ä»¶ã€‘ä¸Šä¼ æ ‡å‡†æ ¼å¼æ•°æ®</li>
            <li>ç‚¹å‡»ã€ğŸš€ è‡ªåŠ¨è®¡ç®—ã€‘è¿›è¡Œåˆ†æ</li>
            <li>æŸ¥çœ‹æ’åã€æŸ±çŠ¶å›¾ä¸é›·è¾¾å›¾</li>
            <li>ç‚¹å‡»ã€ğŸ“¤ å¯¼å‡ºPDFæŠ¥å‘Šã€‘æˆ–ã€ğŸ”— ç”Ÿæˆåˆ†äº«é“¾æ¥ã€‘å…±äº«ç»“æœ</li>
        </ol>
    </div>

    <!-- æ–‡ä»¶ä¸Šä¼ åŒº -->
    <div class="upload-area">
        <p><strong>ğŸ“ ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ Excelæ–‡ä»¶ï¼ˆå¯é€‰ï¼‰</strong></p>
        <input type="file" id="excelFile" accept=".xlsx, .xls" style="display:none;" />
        <button onclick="document.getElementById('excelFile').click()">ğŸ“ é€‰æ‹©Excelæ–‡ä»¶</button>
        <button class="success" onclick="readExcelData()">âœ… ä»Excelå¯¼å…¥</button>
        <div class="loading" id="loading">æ­£åœ¨è§£æExcelï¼Œè¯·ç¨å€™...</div>
    </div>

    <!-- æ“ä½œæŒ‰é’® -->
    <button onclick="addHospital()">â• æ·»åŠ åŒ»é™¢</button>
    <button onclick="removeHospital()">âŒ åˆ é™¤æœ€åä¸€è¡Œ</button>
    <button onclick="calculateTOPSIS()" style="background:#d32f2f">ğŸš€ è‡ªåŠ¨è®¡ç®—</button>
    <button onclick="exportPDF()" class="export">ğŸ“¤ å¯¼å‡ºPDFæŠ¥å‘Š</button>
    <button onclick="exportToUrl()" class="share">ğŸ”— ç”Ÿæˆåˆ†äº«é“¾æ¥</button>

    <!-- æ•°æ®è¾“å…¥è¡¨ -->
    <table id="inputTable">
        <thead>
            <tr>
                <th>åŒ»é™¢åç§°</th>
                <th>é—¨æ€¥è¯Šäººæ¬¡<br>(â†‘)</th>
                <th>å‡ºé™¢æ‚£è€…äººæ¬¡<br>(â†‘)</th>
                <th>é—¨è¯Šæ”¶å…¥(ä¸‡å…ƒ)<br>(â†‘)</th>
                <th>ä½é™¢æ”¶å…¥(ä¸‡å…ƒ)<br>(â†‘)</th>
                <th>æ‰‹æœ¯äººæ¬¡<br>(â†‘)</th>
                <th>æ‰‹æœ¯å æ¯”<br>(â†‘)</th>
                <th>å¹³å‡ä½é™¢æ—¥<br>(â†“)</th>
                <th>è¯å æ¯”<br>(â†“)</th>
                <th>è€—å æ¯”<br>(â†“)</th>
                <th>åŒ»ç–—æœåŠ¡æ”¶å…¥å æ¯”<br>(â†‘)</th>
                <th>Iç±»åˆ‡å£æ„ŸæŸ“ç‡(%)<br>(â†“)</th>
                <th>DDDs<br>(â†“)</th>
                <th>é—¨è¯ŠåŸºè¯å æ¯”(%)<br>(â†‘)</th>
                <th>ä½é™¢åŸºè¯ä½¿ç”¨ç‡(%)<br>(â†‘)</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td contenteditable="true">å¸‚äººæ°‘åŒ»é™¢</td>
                <td contenteditable="true">380000</td>
                <td contenteditable="true">28500</td>
                <td contenteditable="true">18500</td>
                <td contenteditable="true">42000</td>
                <td contenteditable="true">12800</td>
                <td contenteditable="true">0.45</td>
                <td contenteditable="true">8.2</td>
                <td contenteditable="true">28.0</td>
                <td contenteditable="true">19.0</td>
                <td contenteditable="true">36.0</td>
                <td contenteditable="true">0.3</td>
                <td contenteditable="true">380</td>
                <td contenteditable="true">65.0</td>
                <td contenteditable="true">70.0</td>
            </tr>
            <tr>
                <td contenteditable="true">å¸‚ä¸­åŒ»é™¢</td>
                <td contenteditable="true">295000</td>
                <td contenteditable="true">19800</td>
                <td contenteditable="true">15200</td>
                <td contenteditable="true">31000</td>
                <td contenteditable="true">5600</td>
                <td contenteditable="true">0.28</td>
                <td contenteditable="true">9.1</td>
                <td contenteditable="true">25.0</td>
                <td contenteditable="true">16.0</td>
                <td contenteditable="true">39.0</td>
                <td contenteditable="true">0.2</td>
                <td contenteditable="true">320</td>
                <td contenteditable="true">72.0</td>
                <td contenteditable="true">75.0</td>
            </tr>
            <tr>
                <td contenteditable="true">å¿ä¸­å¿ƒåŒ»é™¢</td>
                <td contenteditable="true">220000</td>
                <td contenteditable="true">16500</td>
                <td contenteditable="true">11800</td>
                <td contenteditable="true">28500</td>
                <td contenteditable="true">7200</td>
                <td contenteditable="true">0.44</td>
                <td contenteditable="true">10.5</td>
                <td contenteditable="true">32.0</td>
                <td contenteditable="true">23.0</td>
                <td contenteditable="true">31.0</td>
                <td contenteditable="true">0.6</td>
                <td contenteditable="true">450</td>
                <td contenteditable="true">60.0</td>
                <td contenteditable="true">68.0</td>
            </tr>
        </tbody>
    </table>

    <!-- ç»“æœè¾“å‡º -->
    <h2>ğŸ“Š TOPSISç»¼åˆè¯„ä»·ç»“æœ</h2>
    <table id="resultTable">
        <thead>
            <tr>
                <th>åŒ»é™¢åç§°</th>
                <th>è·æœ€ä¼˜è§£è·ç¦» (diâº)</th>
                <th>è·æœ€åŠ£è§£è·ç¦» (diâ»)</th>
                <th>ç›¸å¯¹è´´è¿‘åº¦ (Ci)</th>
                <th>æ’å</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <!-- å›¾è¡¨åŒºåŸŸ -->
    <h2>ğŸ“ˆ ç»¼åˆå¾—åˆ†æŸ±çŠ¶å›¾</h2>
    <div class="chart-container">
        <canvas id="barChart"></canvas>
    </div>

    <h2>ğŸ” å¤šç»´èƒ½åŠ›é›·è¾¾å›¾ï¼ˆTop 3åŒ»é™¢ï¼‰</h2>
    <div class="chart-container">
        <canvas id="radarChart"></canvas>
    </div>

    <footer>
        Â© 2025 ä¸´æ²‚å¸‚åŒ»ç–—è´¨é‡åˆ†æå·¥å…· | æ”¯æŒç¦»çº¿ä½¿ç”¨ | æ•°æ®æ°¸ä¸ä¸Šä¼ æœåŠ¡å™¨
    </footer>
</div>

<script>
// =======================
// å…¨å±€å˜é‡
// =======================
let barChart = null;
let radarChart = null;
let resultData = [];

// æ‰€æœ‰å­—æ®µåï¼ˆç”¨äºåŒ¹é…Excelï¼‰
const fieldLabels = [
    'mzrs', 'cyrs', 'mj_income', 'zy_income',
    'ssrs', 'ssbl', 'avg_los', 'drug_ratio',
    'consumable_ratio', 'service_income_ratio',
    'infection_rate', 'ddds', 'op_basic_drug', 'ip_basic_drug'
];

// æŒ‡æ ‡æ–¹å‘ï¼štrue=è¶Šé«˜è¶Šå¥½ï¼ˆâ†‘ï¼‰ï¼Œfalse=è¶Šä½è¶Šå¥½ï¼ˆâ†“ï¼‰
const isBenefit = [
    true,   // é—¨æ€¥è¯Šäººæ¬¡ â†‘
    true,   // å‡ºé™¢äººæ¬¡ â†‘
    true,   // é—¨è¯Šæ”¶å…¥ â†‘
    true,   // ä½é™¢æ”¶å…¥ â†‘
    true,   // æ‰‹æœ¯äººæ¬¡ â†‘
    true,   // æ‰‹æœ¯å æ¯” â†‘
    false,  // å¹³å‡ä½é™¢æ—¥ â†“
    false,  // è¯å æ¯” â†“
    false,  // è€—å æ¯” â†“
    true,   // åŒ»ç–—æœåŠ¡æ”¶å…¥å æ¯” â†‘
    false,  // Iç±»åˆ‡å£æ„ŸæŸ“ç‡ â†“
    false,  // DDDs â†“
    true,   // é—¨è¯ŠåŸºè¯å æ¯” â†‘
    true    // ä½é™¢åŸºè¯ä½¿ç”¨ç‡ â†‘
];

// =======================
// æ·»åŠ åŒ»é™¢
// =======================
function addHospital() {
    const tbody = document.querySelector("#inputTable tbody");
    const newRow = document.createElement("tr");
    newRow.innerHTML = `
        <td contenteditable="true">æ–°åŒ»é™¢${tbody.children.length}</td>
        <td contenteditable="true">200000</td>
        <td contenteditable="true">15000</td>
        <td contenteditable="true">10000</td>
        <td contenteditable="true">25000</td>
        <td contenteditable="true">6000</td>
        <td contenteditable="true">0.30</td>
        <td contenteditable="true">9.5</td>
        <td contenteditable="true">30.0</td>
        <td contenteditable="true">20.0</td>
        <td contenteditable="true">33.0</td>
        <td contenteditable="true">0.4</td>
        <td contenteditable="true">400</td>
        <td contenteditable="true">65.0</td>
        <td contenteditable="true">70.0</td>
    `;
    tbody.appendChild(newRow);
}

// =======================
// åˆ é™¤åŒ»é™¢
// =======================
function removeHospital() {
    const tbody = document.querySelector("#inputTable tbody");
    if (tbody.children.length > 1) {
        tbody.removeChild(tbody.lastChild);
    } else {
        alert("è‡³å°‘ä¿ç•™ä¸€å®¶åŒ»é™¢ï¼");
    }
}

// =======================
// è¯»å–Excelå¹¶å¡«å……æ•°æ®
// =======================
function readExcelData() {
    const fileInput = document.getElementById('excelFile');
    if (!fileInput.files.length) {
        alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªExcelæ–‡ä»¶ï¼");
        return;
    }

    const file = fileInput.files[0];
    const reader = new FileReader();
    const loading = document.getElementById('loading');
    loading.style.display = 'block';

    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            const json = XLSX.utils.sheet_to_json(worksheet);

            if (json.length === 0) {
                alert("æœªè¯»å–åˆ°æœ‰æ•ˆæ•°æ®ï¼");
                loading.style.display = 'none';
                return;
            }

            const tbody = document.querySelector("#inputTable tbody");
            tbody.innerHTML = "";

            json.forEach(row => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td contenteditable="true">${row['åŒ»é™¢'] || 'æœªçŸ¥åŒ»é™¢'}</td>
                    <td contenteditable="true">${row['é—¨æ€¥è¯Šäººæ¬¡'] || ''}</td>
                    <td contenteditable="true">${row['å‡ºé™¢æ‚£è€…äººæ¬¡'] || ''}</td>
                    <td contenteditable="true">${row['é—¨è¯Šæ”¶å…¥(ä¸‡å…ƒ)'] || ''}</td>
                    <td contenteditable="true">${row['ä½é™¢æ”¶å…¥(ä¸‡å…ƒ)'] || ''}</td>
                    <td contenteditable="true">${row['æ‰‹æœ¯äººæ¬¡'] || ''}</td>
                    <td contenteditable="true">${row['æ‰‹æœ¯å æ¯”'] || ''}</td>
                    <td contenteditable="true">${row['å¹³å‡ä½é™¢æ—¥'] || ''}</td>
                    <td contenteditable="true">${row['è¯å æ¯”'] || ''}</td>
                    <td contenteditable="true">${row['è€—å æ¯”'] || ''}</td>
                    <td contenteditable="true">${row['åŒ»ç–—æœåŠ¡æ”¶å…¥å æ¯”'] || ''}</td>
                    <td contenteditable="true">${row['Iç±»åˆ‡å£æ„ŸæŸ“ç‡(%)'] || ''}</td>
                    <td contenteditable="true">${row['DDDs'] || ''}</td>
                    <td contenteditable="true">${row['é—¨è¯ŠåŸºè¯å æ¯”(%)'] || ''}</td>
                    <td contenteditable="true">${row['ä½é™¢åŸºè¯ä½¿ç”¨ç‡(%)'] || ''}</td>
                `;
                tbody.appendChild(tr);
            });

            loading.style.display = 'none';
            alert(`âœ… æˆåŠŸå¯¼å…¥ ${json.length} å®¶åŒ»é™¢æ•°æ®ï¼`);

        } catch (err) {
            loading.style.display = 'none';
            alert("âŒ è§£æå¤±è´¥ï¼š" + err.message);
        }
    };

    reader.readAsArrayBuffer(file);
}

// =======================
// æ‰§è¡ŒTOPSISåˆ†æ
// =======================
function calculateTOPSIS() {
    const table = document.getElementById("inputTable");
    const data = [];

    for (let i = 1; i < table.rows.length; i++) {
        const row = table.rows[i];
        const rowData = [row.cells[0].textContent.trim()];
        
        for (let j = 1; j < row.cells.length; j++) {
            let val = parseFloat(row.cells[j].textContent.trim());
            if (isNaN(val)) {
                alert(`ç¬¬${i+1}è¡Œï¼Œâ€œ${row.cells[0].textContent}â€çš„ç¬¬${j}åˆ—æ•°æ®æ— æ•ˆï¼Œè¯·æ£€æŸ¥ï¼`);
                return;
            }
            rowData.push(val);
        }
        data.push(rowData);
    }

    // æå–æ•°å€¼çŸ©é˜µ X
    const X = data.map(row => row.slice(1).map(x => +x));
    const hospitals = data.map(row => row[0]);
    const n = X.length;
    const m = X[0].length;

    // 1. å‘é‡æ ‡å‡†åŒ– R_ij = x_ij / sqrt(sum(x_ij^2))
    const norms = Array(m).fill(0);
    for (let j = 0; j < m; j++) {
        for (let i = 0; i < n; i++) {
            norms[j] += X[i][j] ** 2;
        }
        norms[j] = Math.sqrt(norms[j]);
    }
    const R = X.map(row => row.map((val, j) => val / (norms[j] + 1e-8)));

    // 2. ç†µæƒæ³•èµ‹æƒ
    function entropyWeight(matrix) {
        const eps = 1e-8;
        const P = matrix[0].map((_, j) => matrix.map(row => row[j]));
        const e = P.map(col => {
            const sum = col.reduce((a,b) => a+b, 0);
            const p = col.map(v => (v + eps) / (sum + eps));
            return -p.reduce((sum_p, pi) => sum_p + pi * Math.log(pi), 0) / Math.log(col.length);
        });
        const g = e.map(ej => 1 - ej);
        const sumG = g.reduce((a,b) => a+b, 0);
        return g.map(w => w / sumG);
    }
    const weights = entropyWeight(R);

    // 3. åŠ æƒæ ‡å‡†åŒ–çŸ©é˜µ V
    const V = R.map(row => row.map((val, j) => val * weights[j]));

    // 4. æ­£è´Ÿç†æƒ³è§£ A+, A-
    const A_plus = V[0].map((_, j) =>
        isBenefit[j] ? Math.max(...V.map(r => r[j])) : Math.min(...V.map(r => r[j]))
    );
    const A_minus = V[0].map((_, j) =>
        isBenefit[j] ? Math.min(...V.map(r => r[j])) : Math.max(...V.map(r => r[j]))
    );

    // 5. æ¬§æ°è·ç¦» di+, di-
    function distance(row, point) {
        return Math.sqrt(row.reduce((sum, val, j) => sum + (val - point[j])**2, 0));
    }
    const d_plus = V.map(row => distance(row, A_plus));
    const d_minus = V.map(row => distance(row, A_minus));

    // 6. ç›¸å¯¹æ¥è¿‘åº¦ Ci
    const Ci = d_minus.map((d_min, i) => d_min / (d_min + d_plus[i] + 1e-8));

    // 7. æ’åº
    resultData = hospitals.map((h, i) => ({
        hospital: h,
        di_plus: d_plus[i],
        di_minus: d_minus[i],
        ci: Ci[i]
    })).sort((a, b) => b.ci - a.ci);

    resultData.forEach((r, i) => r.rank = i + 1);

    // 8. è¾“å‡ºç»“æœ
    displayResults();
    drawCharts();
}

// =======================
// æ˜¾ç¤ºç»“æœè¡¨æ ¼
// =======================
function displayResults() {
    const tbody = document.querySelector("#resultTable tbody");
    tbody.innerHTML = "";
    resultData.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${r.hospital}</td>
            <td>${r.di_plus.toFixed(4)}</td>
            <td>${r.di_minus.toFixed(4)}</td>
            <td><strong>${r.ci.toFixed(3)}</strong></td>
            <td><strong>${r.rank}</strong></td>
        `;
        tbody.appendChild(tr);
    });
}

// =======================
// ç»˜åˆ¶å›¾è¡¨
// =======================
function drawCharts() {
    if (barChart) barChart.destroy();
    if (radarChart) radarChart.destroy();

    // æŸ±çŠ¶å›¾
    const ctxBar = document.getElementById("barChart").getContext("2d");
    barChart = new Chart(ctxBar, {
        type: 'bar',
        data: {
            labels: resultData.map(r => r.hospital),
            datasets: [{
                label: 'ç›¸å¯¹è´´è¿‘åº¦ (Ci)',
                data: resultData.map(r => r.ci),
                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: { y: { beginAtZero: true, max: 1.0 } },
            plugins: { legend: { position: 'top' } }
        }
    });

    // é›·è¾¾å›¾ï¼ˆTop 3ï¼‰
    const top3 = resultData.slice(0, 3);
    const ctxRadar = document.getElementById("radarChart").getContext("2d");
    radarChart = new Chart(ctxRadar, {
        type: 'radar',
        data: {
            labels: ['æœåŠ¡èƒ½åŠ›', 'æ‰‹æœ¯èƒ½åŠ›', 'æ•ˆç‡', 'ç”¨è¯å®‰å…¨', 'åˆç†ç”¨è¯'],
            datasets: top3.map((r, i) => {
                const row = Array.from(document.querySelectorAll("#inputTable tbody tr"))
                                .find(tr => tr.cells[0].textContent.trim() === r.hospital);
                const values = row ? Array.from(row.cells).slice(1).map(td => parseFloat(td.textContent)) : Array(14).fill(0);
                return {
                    label: r.hospital,
                    data: [
                        (values[0] + values[1]) / 100000,     // æœåŠ¡é‡
                        values[5],                           // æ‰‹æœ¯å æ¯”
                        1 / values[6],                       // æ•ˆç‡
                        1 / values[11],                      // DDDs
                        (values[12] + values[13]) / 2       // åŸºè¯ä½¿ç”¨
                    ].map(x => Math.max(0.1, Math.min(1, x / 10))), // å½’ä¸€åŒ–
                    backgroundColor: [`rgba(255,99,132,0.2)`,`rgba(54,162,235,0.2)`,`rgba(255,205,86,0.2)`][i],
                    borderColor: [`rgba(255,99,132,1)`,`rgba(54,162,235,1)`,`rgba(255,205,86,1)`][i],
                    pointBackgroundColor: 'white'
                };
            })
        },
        options: {
            scales: { r: { suggestedMin: 0, suggestedMax: 1 } },
            responsive: true
        }
    });
}

// =======================
// å¯¼å‡ºPDFæŠ¥å‘Š
// =======================
function exportPDF() {
    if (!resultData || resultData.length === 0) {
        alert("è¯·å…ˆè¿è¡Œåˆ†æï¼");
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    doc.setFontSize(20);
    doc.text("ä¸´æ²‚å¸‚å…¬ç«‹åŒ»é™¢åŒ»ç–—æœåŠ¡è´¨é‡è¯„ä»·æŠ¥å‘Š", 105, 20, { align: "center" });
    doc.setFontSize(12);
    doc.text(`ç”Ÿæˆæ—¥æœŸï¼š${new Date().toLocaleDateString()}`, 140, 30);

    // è¡¨æ ¼
    const tableData = resultData.map(r => [
        r.hospital,
        r.di_plus.toFixed(4),
        r.di_minus.toFixed(4),
        r.ci.toFixed(3),
        r.rank
    ]);
    doc.autoTable({
        head: [['åŒ»é™¢', 'diâº', 'diâ»', 'Ci', 'æ’å']],
        body: tableData,
        startY: 40
    });

    const finalY = doc.lastAutoTable.finalY + 10;
    doc.setFontSize(10);
    doc.text("æ³¨ï¼šé‡‡ç”¨TOPSIS+ç†µæƒæ³•æ¨¡å‹ï¼ŒåŸºäº14é¡¹æ ¸å¿ƒæŒ‡æ ‡ç»¼åˆæµ‹ç®—ã€‚", 10, finalY);
    doc.text("Ciå€¼è¶Šæ¥è¿‘1è¡¨ç¤ºæ•´ä½“æœåŠ¡è´¨é‡è¶Šé«˜ã€‚", 10, finalY + 5);

    doc.save(`åŒ»ç–—æœåŠ¡è´¨é‡TOPSISè¯„ä»·_${new Date().getTime()}.pdf`);
}

// =======================
// ğŸ”— å°†å½“å‰æ•°æ®å¯¼å‡ºä¸ºå¯åˆ†äº«çš„é“¾æ¥
// =======================
function exportToUrl() {
    const table = document.getElementById("inputTable");
    const data = [];

    for (let i = 1; i < table.rows.length; i++) {
        const row = table.rows[i];
        const rowData = [];
        for (let j = 0; j < row.cells.length; j++) {
            rowData.push(row.cells[j].textContent.trim());
        }
        data.push(rowData);
    }

    const jsonStr = JSON.stringify(data);
    const compressed = LZString.compressToEncodedURIComponent(jsonStr);

    const baseUrl = window.location.href.split('?')[0];
    const url = new URL(baseUrl);
    url.searchParams.set('data', compressed);

    navigator.clipboard.writeText(url.toString())
        .then(() => {
            alert("âœ… å½“å‰æ•°æ®å·²ç”Ÿæˆé“¾æ¥å¹¶å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼\n\nä»»ä½•äººæ‰“å¼€æ­¤é“¾æ¥éƒ½èƒ½çœ‹åˆ°ç›¸åŒå†…å®¹ï¼");
        })
        .catch(err => {
            const msg = "ğŸ”— è¯·æ‰‹åŠ¨å¤åˆ¶ä»¥ä¸‹é“¾æ¥åˆ†äº«ï¼š\n\n" + url.toString();
            prompt("åˆ†äº«é“¾æ¥å·²ç”Ÿæˆ", url.toString());
        });

    window.history.replaceState({}, '', url);
}

// =======================
// ğŸ“¥ ä»URLåŠ è½½æ•°æ®ï¼ˆé¡µé¢åŠ è½½æ—¶è°ƒç”¨ï¼‰
// =======================
window.addEventListener('load', function () {
    importFromUrl();
});

function importFromUrl() {
    const url = new URL(window.location);
    const param = url.searchParams.get('data');
    if (!param) return;

    try {
        const jsonStr = LZString.decompressFromEncodedURIComponent(param);
        const data = JSON.parse(jsonStr);

        const tbody = document.querySelector("#inputTable tbody");
        tbody.innerHTML = "";

        data.forEach(row => {
            const tr = document.createElement("tr");
            tr.innerHTML = row.map(cell => 
                `<td contenteditable="true">${cell}</td>`
            ).join("");
            tbody.appendChild(tr);
        });

        console.log("âœ… å·²ä»URLæ¢å¤æ•°æ®");
        alert("ğŸ“Š å·²ä»é“¾æ¥æ¢å¤æ•°æ®ï¼ç‚¹å‡»ã€è‡ªåŠ¨è®¡ç®—ã€‘å³å¯é‡ç°åˆ†æç»“æœ");

    } catch (e) {
        console.error("âŒ æ— æ³•è§£æURLä¸­çš„æ•°æ®", e);
        alert("âš ï¸ æ— æ³•æ¢å¤é“¾æ¥ä¸­çš„æ•°æ®ï¼Œè¯·æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆé“¾æ¥ã€‚");
    }
}
</script>

</body>
</html>
